---
name: Test Radosgw
on:
  pull_request:
    branches:
      - "s3gw"

jobs:
  build:
    uses: ./.github/workflows/build-radosgw.yml

  build-container:
    runs-on: ubuntu-latest
    needs:
      - build

    steps:
      - name: Checkout s3gw-tools
        uses: actions/checkout@v3
        with:
          repository: 'aquarist-labs/s3gw-tools'
          ref: 'main'
          path: 's3gw-tools'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Radogw Artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.build.outputs.artifact_id }}

      - name: Unpack Artifacts
        run: |
          tar -xvf build-results.tar.gz

      - name: Build S3GW-TEST Container
        uses: docker/build-push-action@v3
        with:
          tags: s3gw:unittest-${{ env.GITHUB_REF_NAME }}
          file: s3gw-tools/build/Dockerfile.build-radosgw-test-container
          context: ceph/build
          outputs: type=docker,dest=/tmp/s3gw-unittest-${{ env.GITHUB_REF_NAME }}.tar

      - name: Build S3GW Container
        uses: docker/build-push-action@v3
        with:
          tags: s3gw:test-${{ env.GITHUB_REF_NAME }}
          file: s3gw-tools/build/Dockerfile.build-container
          context: ceph/build
          outputs: type=docker,dest=/tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar

      - name: Uplaod Artifact
        uses: actions/upload-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: |
            /tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
            /tmp/s3gw-unittest-${{ env.GITHUB_REF_NAME }}.tar

  unit-test:
    runs-on: ubuntu-latest
    needs:
      - build-container

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: /tmp

      - name: Load Image
        run: |
          docker load --input //tmp/s3gw-unittest-${{ env.GITHUB_REF_NAME }}.tar
          docker image ls -a

      - name: Install S3cmd
        run: |
          docker run s3gw:unittest-${{ env.GITHUB_REF_NAME }}

  smoke-test:
    runs-on: ubuntu-latest
    needs:
      - build-container

    steps:
      - name: Checkout s3gw-tools
        uses: actions/checkout@v3
        with:
          repository: 'aquarist-labs/s3gw-tools'
          ref: 'main'
          path: 's3gw-tools'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: /tmp

      - name: Load Image
        run: |
          docker load --input //tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
          docker image ls -a

      - name: Install S3cmd
        run: |
          sudo apt-get update
          sudo apt-get install -y s3cmd

      - name: Run Smoke Tests
        run: |
          mkdir storage
          docker run -d \
            -v ${{ env.GITHUB_WORKSPACE }}/storage:/data \
            -p 7480:7480 \
            s3gw:test-${{ env.GITHUB_REF_NAME }} \
              --rgw-backend-store sfs \
              --debug-rgw 1

          sleep 5
          # ^ This is needed to give the gateway some time to boot up.
          # It also serves to make sure the gateway takes no more than 5 seconds
          # to boot up.

          echo "Running Smoke Tests:\n"
          s3gw-tools/tests/s3gw-smoke-test.sh localhost:7480
#
#   s3tests:
#     runs-on: ubuntu-latest
#     needs:
#       - build-container
#
#     steps:
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v2
#
#       - name: Download Artifact
#         uses: actions/download-artifact@v3
#         with:
#           name: s3gw-test-${{ env.GITHUB_REF_NAME }}
#           path: /tmp
#
#       - name: Load Image
#         run: |
#           docker load --input //tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
#           docker image ls -a
#
#       - name: Setup Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.8'
#
#       - name: Checkout s3tests
#         uses: actions/checkout@v3
#         with:
#           repository: 'ceph/s3-tests'
#           ref: 'master'
#           path: 's3tests'
#
#       - name: Setup s3tests
#         run: |
#           pip install -r s3tests/requirements.txt
#
#           cat <<EOF > all-s3tests
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_cloud_multiple_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_cloud_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_cloud_transition_large_obj
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_deletemarker_expiration
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_date
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_days0
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_header_and_tags_head
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_header_head
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_header_put
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_header_tags_head
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_noncur_tags1
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_tags1
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_tags2
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_versioned_tags2
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_expiration_versioning_enabled
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_get
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_get_no_id
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_id_too_long
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_invalid_status
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_multipart_expiration
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_noncur_cloud_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_noncur_expiration
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_noncur_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_same_id
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_date
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_deletemarker
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_empty_filter
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_filter
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_invalid_date
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_multipart
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_noncurrent
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_set_noncurrent_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_transition
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_transition_set_invalid_date
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecycle_transition_single_rule_multi_trans
#           # BOOM: s3tests_boto3.functional.test_s3:test_lifecyclev2_expiration
#           # BOOM: s3tests_boto3.functional.test_s3:test_multipart_resend_first_finishes_last
#           # BOOM: s3tests_boto3.functional.test_s3:test_multipart_upload_resend_part
#           # BOOM: s3tests_boto3.functional.test_s3:test_object_copy_to_itself
#           # BOOM: s3tests_boto3.functional.test_s3:test_post_object_anonymous_request
#           # BOOM: s3tests_boto3.functional.test_s3:test_post_object_authenticated_no_content_type
#           # BOOM: s3tests_boto3.functional.test_s3:test_post_object_set_success_code
#           # BOOM: s3tests_boto3.functional.test_s3:test_versioning_multi_object_delete_with_marker_create
#           s3tests_boto3.functional.test_s3:test_100_continue
#           s3tests_boto3.functional.test_s3:test_abort_multipart_upload
#           s3tests_boto3.functional.test_s3:test_abort_multipart_upload_not_found
#           s3tests_boto3.functional.test_s3:test_account_usage
#           s3tests_boto3.functional.test_s3:test_atomic_conditional_write_1mb
#           s3tests_boto3.functional.test_s3:test_atomic_dual_conditional_write_1mb
#           s3tests_boto3.functional.test_s3:test_atomic_dual_write_1mb
#           s3tests_boto3.functional.test_s3:test_atomic_dual_write_4mb
#           s3tests_boto3.functional.test_s3:test_atomic_dual_write_8mb
#           s3tests_boto3.functional.test_s3:test_atomic_multipart_upload_write
#           s3tests_boto3.functional.test_s3:test_atomic_read_1mb
#           s3tests_boto3.functional.test_s3:test_atomic_read_4mb
#           s3tests_boto3.functional.test_s3:test_atomic_read_8mb
#           s3tests_boto3.functional.test_s3:test_atomic_write_1mb
#           s3tests_boto3.functional.test_s3:test_atomic_write_4mb
#           s3tests_boto3.functional.test_s3:test_atomic_write_8mb
#           s3tests_boto3.functional.test_s3:test_atomic_write_bucket_gone
#           s3tests_boto3.functional.test_s3:test_basic_key_count
#           s3tests_boto3.functional.test_s3:test_block_public_object_canned_acls
#           s3tests_boto3.functional.test_s3:test_block_public_policy
#           s3tests_boto3.functional.test_s3:test_block_public_put_bucket_acls
#           s3tests_boto3.functional.test_s3:test_bucket_acl_canned
#           s3tests_boto3.functional.test_s3:test_bucket_acl_canned_authenticatedread
#           s3tests_boto3.functional.test_s3:test_bucket_acl_canned_during_create
#           s3tests_boto3.functional.test_s3:test_bucket_acl_canned_private_to_private
#           s3tests_boto3.functional.test_s3:test_bucket_acl_canned_publicreadwrite
#           s3tests_boto3.functional.test_s3:test_bucket_acl_default
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_email
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_email_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_nonexist_user
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_userid_fullcontrol
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_userid_read
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_userid_readacp
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_userid_write
#           s3tests_boto3.functional.test_s3:test_bucket_acl_grant_userid_writeacp
#           s3tests_boto3.functional.test_s3:test_bucket_acl_no_grants
#           s3tests_boto3.functional.test_s3:test_bucket_acl_revoke_all
#           s3tests_boto3.functional.test_s3:test_bucket_concurrent_set_canned_acl
#           s3tests_boto3.functional.test_s3:test_bucket_create_delete
#           s3tests_boto3.functional.test_s3:test_bucket_create_exists
#           s3tests_boto3.functional.test_s3:test_bucket_create_exists_nonowner
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_bad_ip
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_bad_short_one
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_bad_short_two
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_bad_starts_nonalpha
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_dash_at_end
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_dash_dot
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_dot_dash
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_dot_dot
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_long
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_dns_underscore
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_contains_hyphen
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_contains_period
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_long_60
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_long_61
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_long_62
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_long_63
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_starts_alpha
#           s3tests_boto3.functional.test_s3:test_bucket_create_naming_good_starts_digit
#           s3tests_boto3.functional.test_s3:test_bucket_create_special_key_names
#           s3tests_boto3.functional.test_s3:test_bucket_delete_nonempty
#           s3tests_boto3.functional.test_s3:test_bucket_delete_notexist
#           s3tests_boto3.functional.test_s3:test_bucket_get_location
#           s3tests_boto3.functional.test_s3:test_bucket_head
#           s3tests_boto3.functional.test_s3:test_bucket_head_extended
#           s3tests_boto3.functional.test_s3:test_bucket_head_notexist
#           s3tests_boto3.functional.test_s3:test_bucket_header_acl_grants
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_alt
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_basic
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_dot
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_empty
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_none
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_not_skip_special
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_percentage
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix_ends_with_delimiter
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix_underscore
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_whitespace
#           s3tests_boto3.functional.test_s3:test_bucket_list_distinct
#           s3tests_boto3.functional.test_s3:test_bucket_list_empty
#           s3tests_boto3.functional.test_s3:test_bucket_list_encoding_basic
#           s3tests_boto3.functional.test_s3:test_bucket_list_long_name
#           s3tests_boto3.functional.test_s3:test_bucket_list_many
#           s3tests_boto3.functional.test_s3:test_bucket_list_marker_after_list
#           s3tests_boto3.functional.test_s3:test_bucket_list_marker_empty
#           s3tests_boto3.functional.test_s3:test_bucket_list_marker_none
#           s3tests_boto3.functional.test_s3:test_bucket_list_marker_not_in_list
#           s3tests_boto3.functional.test_s3:test_bucket_list_marker_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_invalid
#           s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_none
#           s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_one
#           s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_zero
#           s3tests_boto3.functional.test_s3:test_bucket_list_objects_anonymous
#           s3tests_boto3.functional.test_s3:test_bucket_list_objects_anonymous_fail
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_alt
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_basic
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_alt
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_basic
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_prefix_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_prefix_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_empty
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_none
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_list_prefix_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_list_return_data
#           s3tests_boto3.functional.test_s3:test_bucket_list_return_data_versioning
#           s3tests_boto3.functional.test_s3:test_bucket_list_special_prefix
#           s3tests_boto3.functional.test_s3:test_bucket_list_unordered
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_both_continuationtoken_startafter
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_continuationtoken
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_continuationtoken_empty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_alt
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_basic
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_dot
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_empty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_none
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_percentage
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix_ends_with_delimiter
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix_underscore
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_whitespace
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_encoding_basic
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_defaultempty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_empty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_notempty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_many
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_none
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_one
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_zero
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_objects_anonymous
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_objects_anonymous_fail
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_alt
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_basic
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_alt
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_basic
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_prefix_delimiter_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_prefix_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_empty
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_none
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_not_exist
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_after_list
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_not_in_list
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_unreadable
#           s3tests_boto3.functional.test_s3:test_bucket_listv2_unordered
#           s3tests_boto3.functional.test_s3:test_bucket_notexist
#           s3tests_boto3.functional.test_s3:test_bucket_policy
#           s3tests_boto3.functional.test_s3:test_bucket_policy_acl
#           s3tests_boto3.functional.test_s3:test_bucket_policy_another_bucket
#           s3tests_boto3.functional.test_s3:test_bucket_policy_different_tenant
#           s3tests_boto3.functional.test_s3:test_bucket_policy_get_obj_acl_existing_tag
#           s3tests_boto3.functional.test_s3:test_bucket_policy_get_obj_existing_tag
#           s3tests_boto3.functional.test_s3:test_bucket_policy_get_obj_tagging_existing_tag
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_acl
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_copy_source
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_copy_source_meta
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_grant
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_kms_noenc
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_kms_s3
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_request_obj_tag
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_s3_kms
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_s3_noenc
#           s3tests_boto3.functional.test_s3:test_bucket_policy_put_obj_tagging_existing_tag
#           s3tests_boto3.functional.test_s3:test_bucket_policy_set_condition_operator_end_with_IfExists
#           s3tests_boto3.functional.test_s3:test_bucket_recreate_new_acl
#           s3tests_boto3.functional.test_s3:test_bucket_recreate_not_overriding
#           s3tests_boto3.functional.test_s3:test_bucket_recreate_overwrite_acl
#           s3tests_boto3.functional.test_s3:test_buckets_create_then_list
#           s3tests_boto3.functional.test_s3:test_buckets_list_ctime
#           s3tests_boto3.functional.test_s3:test_bucketv2_notexist
#           s3tests_boto3.functional.test_s3:test_bucketv2_policy
#           s3tests_boto3.functional.test_s3:test_bucketv2_policy_acl
#           s3tests_boto3.functional.test_s3:test_bucketv2_policy_another_bucket
#           s3tests_boto3.functional.test_s3:test_bucketv2_policy_different_tenant
#           s3tests_boto3.functional.test_s3:test_copy_object_ifmatch_failed
#           s3tests_boto3.functional.test_s3:test_copy_object_ifmatch_good
#           s3tests_boto3.functional.test_s3:test_copy_object_ifnonematch_failed
#           s3tests_boto3.functional.test_s3:test_copy_object_ifnonematch_good
#           s3tests_boto3.functional.test_s3:test_cors_header_option
#           s3tests_boto3.functional.test_s3:test_cors_origin_response
#           s3tests_boto3.functional.test_s3:test_cors_origin_wildcard
#           s3tests_boto3.functional.test_s3:test_delete_bucket_encryption_kms
#           s3tests_boto3.functional.test_s3:test_delete_bucket_encryption_s3
#           s3tests_boto3.functional.test_s3:test_delete_tags_obj_public
#           s3tests_boto3.functional.test_s3:test_encrypted_transfer_13b
#           s3tests_boto3.functional.test_s3:test_encrypted_transfer_1MB
#           s3tests_boto3.functional.test_s3:test_encrypted_transfer_1b
#           s3tests_boto3.functional.test_s3:test_encrypted_transfer_1kb
#           s3tests_boto3.functional.test_s3:test_encryption_key_no_sse_c
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_invalid_md5
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_method_head
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_multipart_bad_download
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_multipart_invalid_chunks_1
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_multipart_invalid_chunks_2
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_multipart_upload
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_no_key
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_no_md5
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_other_key
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_post_object_authenticated_request
#           s3tests_boto3.functional.test_s3:test_encryption_sse_c_present
#           s3tests_boto3.functional.test_s3:test_get_authpublic_acl_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_bucket_encryption_kms
#           s3tests_boto3.functional.test_s3:test_get_bucket_encryption_s3
#           s3tests_boto3.functional.test_s3:test_get_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_default_public_block
#           s3tests_boto3.functional.test_s3:test_get_nonpublicpolicy_acl_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_nonpublicpolicy_deny_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_obj_head_tagging
#           s3tests_boto3.functional.test_s3:test_get_obj_tagging
#           s3tests_boto3.functional.test_s3:test_get_object_ifmatch_failed
#           s3tests_boto3.functional.test_s3:test_get_object_ifmatch_good
#           s3tests_boto3.functional.test_s3:test_get_object_ifmodifiedsince_failed
#           s3tests_boto3.functional.test_s3:test_get_object_ifmodifiedsince_good
#           s3tests_boto3.functional.test_s3:test_get_object_ifnonematch_failed
#           s3tests_boto3.functional.test_s3:test_get_object_ifnonematch_good
#           s3tests_boto3.functional.test_s3:test_get_object_ifunmodifiedsince_failed
#           s3tests_boto3.functional.test_s3:test_get_object_ifunmodifiedsince_good
#           s3tests_boto3.functional.test_s3:test_get_public_acl_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_publicpolicy_acl_bucket_policy_status
#           s3tests_boto3.functional.test_s3:test_get_tags_acl_public
#           s3tests_boto3.functional.test_s3:test_head_bucket_usage
#           s3tests_boto3.functional.test_s3:test_ignore_public_acls
#           s3tests_boto3.functional.test_s3:test_list_buckets_anonymous
#           s3tests_boto3.functional.test_s3:test_list_buckets_bad_auth
#           s3tests_boto3.functional.test_s3:test_list_buckets_invalid_auth
#           s3tests_boto3.functional.test_s3:test_list_multipart_upload
#           s3tests_boto3.functional.test_s3:test_list_multipart_upload_owner
#           s3tests_boto3.functional.test_s3:test_logging_toggle
#           s3tests_boto3.functional.test_s3:test_multi_object_delete
#           s3tests_boto3.functional.test_s3:test_multi_object_delete_key_limit
#           s3tests_boto3.functional.test_s3:test_multi_objectv2_delete
#           s3tests_boto3.functional.test_s3:test_multi_objectv2_delete_key_limit
#           s3tests_boto3.functional.test_s3:test_multipart_copy_improper_range
#           s3tests_boto3.functional.test_s3:test_multipart_copy_invalid_range
#           s3tests_boto3.functional.test_s3:test_multipart_copy_multiple_sizes
#           s3tests_boto3.functional.test_s3:test_multipart_copy_small
#           s3tests_boto3.functional.test_s3:test_multipart_copy_special_names
#           s3tests_boto3.functional.test_s3:test_multipart_copy_versioned
#           s3tests_boto3.functional.test_s3:test_multipart_copy_without_range
#           s3tests_boto3.functional.test_s3:test_multipart_upload
#           s3tests_boto3.functional.test_s3:test_multipart_upload_contents
#           s3tests_boto3.functional.test_s3:test_multipart_upload_empty
#           s3tests_boto3.functional.test_s3:test_multipart_upload_incorrect_etag
#           s3tests_boto3.functional.test_s3:test_multipart_upload_missing_part
#           s3tests_boto3.functional.test_s3:test_multipart_upload_multiple_sizes
#           s3tests_boto3.functional.test_s3:test_multipart_upload_on_a_bucket_with_policy
#           s3tests_boto3.functional.test_s3:test_multipart_upload_overwrite_existing_object
#           s3tests_boto3.functional.test_s3:test_multipart_upload_size_too_small
#           s3tests_boto3.functional.test_s3:test_multipart_upload_small
#           s3tests_boto3.functional.test_s3:test_object_acl
#           s3tests_boto3.functional.test_s3:test_object_acl_canned
#           s3tests_boto3.functional.test_s3:test_object_acl_canned_authenticatedread
#           s3tests_boto3.functional.test_s3:test_object_acl_canned_bucketownerfullcontrol
#           s3tests_boto3.functional.test_s3:test_object_acl_canned_bucketownerread
#           s3tests_boto3.functional.test_s3:test_object_acl_canned_during_create
#           s3tests_boto3.functional.test_s3:test_object_acl_canned_publicreadwrite
#           s3tests_boto3.functional.test_s3:test_object_acl_default
#           s3tests_boto3.functional.test_s3:test_object_acl_full_control_verify_attributes
#           s3tests_boto3.functional.test_s3:test_object_acl_full_control_verify_owner
#           s3tests_boto3.functional.test_s3:test_object_acl_read
#           s3tests_boto3.functional.test_s3:test_object_acl_readacp
#           s3tests_boto3.functional.test_s3:test_object_acl_write
#           s3tests_boto3.functional.test_s3:test_object_acl_writeacp
#           s3tests_boto3.functional.test_s3:test_object_anon_put
#           s3tests_boto3.functional.test_s3:test_object_anon_put_write_access
#           s3tests_boto3.functional.test_s3:test_object_copy_16m
#           s3tests_boto3.functional.test_s3:test_object_copy_bucket_not_found
#           s3tests_boto3.functional.test_s3:test_object_copy_canned_acl
#           s3tests_boto3.functional.test_s3:test_object_copy_diff_bucket
#           s3tests_boto3.functional.test_s3:test_object_copy_key_not_found
#           s3tests_boto3.functional.test_s3:test_object_copy_not_owned_bucket
#           s3tests_boto3.functional.test_s3:test_object_copy_not_owned_object_bucket
#           s3tests_boto3.functional.test_s3:test_object_copy_replacing_metadata
#           s3tests_boto3.functional.test_s3:test_object_copy_retaining_metadata
#           s3tests_boto3.functional.test_s3:test_object_copy_same_bucket
#           s3tests_boto3.functional.test_s3:test_object_copy_to_itself_with_metadata
#           s3tests_boto3.functional.test_s3:test_object_copy_verify_contenttype
#           s3tests_boto3.functional.test_s3:test_object_copy_versioned_bucket
#           s3tests_boto3.functional.test_s3:test_object_copy_versioned_url_encoding
#           s3tests_boto3.functional.test_s3:test_object_copy_versioning_multipart_upload
#           s3tests_boto3.functional.test_s3:test_object_copy_zero_size
#           s3tests_boto3.functional.test_s3:test_object_delete_key_bucket_gone
#           s3tests_boto3.functional.test_s3:test_object_head_zero_bytes
#           s3tests_boto3.functional.test_s3:test_object_header_acl_grants
#           s3tests_boto3.functional.test_s3:test_object_lock_changing_mode_from_compliance
#           s3tests_boto3.functional.test_s3:test_object_lock_changing_mode_from_governance_with_bypass
#           s3tests_boto3.functional.test_s3:test_object_lock_changing_mode_from_governance_without_bypass
#           s3tests_boto3.functional.test_s3:test_object_lock_delete_object_with_legal_hold_off
#           s3tests_boto3.functional.test_s3:test_object_lock_delete_object_with_legal_hold_on
#           s3tests_boto3.functional.test_s3:test_object_lock_delete_object_with_retention
#           s3tests_boto3.functional.test_s3:test_object_lock_delete_object_with_retention_and_marker
#           s3tests_boto3.functional.test_s3:test_object_lock_get_legal_hold
#           s3tests_boto3.functional.test_s3:test_object_lock_get_legal_hold_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_lock
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_lock_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_metadata
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_retention
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_retention_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_get_obj_retention_iso8601
#           s3tests_boto3.functional.test_s3:test_object_lock_multi_delete_object_with_retention
#           s3tests_boto3.functional.test_s3:test_object_lock_put_legal_hold
#           s3tests_boto3.functional.test_s3:test_object_lock_put_legal_hold_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_put_legal_hold_invalid_status
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_invalid_days
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_invalid_mode
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_invalid_status
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_invalid_years
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_lock_with_days_and_years
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_increase_period
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_invalid_bucket
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_invalid_mode
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_override_default_retention
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_shorten_period
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_shorten_period_bypass
#           s3tests_boto3.functional.test_s3:test_object_lock_put_obj_retention_versionid
#           s3tests_boto3.functional.test_s3:test_object_lock_suspend_versioning
#           s3tests_boto3.functional.test_s3:test_object_lock_uploading_obj
#           s3tests_boto3.functional.test_s3:test_object_metadata_replaced_on_put
#           s3tests_boto3.functional.test_s3:test_object_put_authenticated
#           s3tests_boto3.functional.test_s3:test_object_raw_authenticated
#           s3tests_boto3.functional.test_s3:test_object_raw_authenticated_bucket_acl
#           s3tests_boto3.functional.test_s3:test_object_raw_authenticated_bucket_gone
#           s3tests_boto3.functional.test_s3:test_object_raw_authenticated_object_acl
#           s3tests_boto3.functional.test_s3:test_object_raw_authenticated_object_gone
#           s3tests_boto3.functional.test_s3:test_object_raw_get
#           s3tests_boto3.functional.test_s3:test_object_raw_get_bucket_acl
#           s3tests_boto3.functional.test_s3:test_object_raw_get_bucket_gone
#           s3tests_boto3.functional.test_s3:test_object_raw_get_object_acl
#           s3tests_boto3.functional.test_s3:test_object_raw_get_object_gone
#           s3tests_boto3.functional.test_s3:test_object_raw_get_x_amz_expires_not_expired
#           s3tests_boto3.functional.test_s3:test_object_raw_get_x_amz_expires_out_max_range
#           s3tests_boto3.functional.test_s3:test_object_raw_get_x_amz_expires_out_positive_range
#           s3tests_boto3.functional.test_s3:test_object_raw_get_x_amz_expires_out_range_zero
#           s3tests_boto3.functional.test_s3:test_object_raw_put_authenticated_expired
#           s3tests_boto3.functional.test_s3:test_object_raw_response_headers
#           s3tests_boto3.functional.test_s3:test_object_read_not_exist
#           s3tests_boto3.functional.test_s3:test_object_read_unreadable
#           s3tests_boto3.functional.test_s3:test_object_requestid_matches_header_on_error
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_empty_to_unreadable_infix
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_empty_to_unreadable_prefix
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_empty_to_unreadable_suffix
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_none_to_empty
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_none_to_good
#           s3tests_boto3.functional.test_s3:test_object_set_get_metadata_overwrite_to_empty
#           s3tests_boto3.functional.test_s3:test_object_set_get_non_utf8_metadata
#           s3tests_boto3.functional.test_s3:test_object_set_get_unicode_metadata
#           s3tests_boto3.functional.test_s3:test_object_write_cache_control
#           s3tests_boto3.functional.test_s3:test_object_write_check_etag
#           s3tests_boto3.functional.test_s3:test_object_write_expires
#           s3tests_boto3.functional.test_s3:test_object_write_file
#           s3tests_boto3.functional.test_s3:test_object_write_read_update_read_delete
#           s3tests_boto3.functional.test_s3:test_object_write_to_nonexist_bucket
#           s3tests_boto3.functional.test_s3:test_post_object_authenticated_request
#           s3tests_boto3.functional.test_s3:test_post_object_authenticated_request_bad_access_key
#           s3tests_boto3.functional.test_s3:test_post_object_case_insensitive_condition_fields
#           s3tests_boto3.functional.test_s3:test_post_object_condition_is_case_sensitive
#           s3tests_boto3.functional.test_s3:test_post_object_empty_conditions
#           s3tests_boto3.functional.test_s3:test_post_object_escaped_field_values
#           s3tests_boto3.functional.test_s3:test_post_object_expired_policy
#           s3tests_boto3.functional.test_s3:test_post_object_expires_is_case_sensitive
#           s3tests_boto3.functional.test_s3:test_post_object_ignored_header
#           s3tests_boto3.functional.test_s3:test_post_object_invalid_access_key
#           s3tests_boto3.functional.test_s3:test_post_object_invalid_content_length_argument
#           s3tests_boto3.functional.test_s3:test_post_object_invalid_date_format
#           s3tests_boto3.functional.test_s3:test_post_object_invalid_request_field_value
#           s3tests_boto3.functional.test_s3:test_post_object_invalid_signature
#           s3tests_boto3.functional.test_s3:test_post_object_missing_conditions_list
#           s3tests_boto3.functional.test_s3:test_post_object_missing_content_length_argument
#           s3tests_boto3.functional.test_s3:test_post_object_missing_expires_condition
#           s3tests_boto3.functional.test_s3:test_post_object_missing_policy_condition
#           s3tests_boto3.functional.test_s3:test_post_object_missing_signature
#           s3tests_boto3.functional.test_s3:test_post_object_no_key_specified
#           s3tests_boto3.functional.test_s3:test_post_object_request_missing_policy_specified_field
#           s3tests_boto3.functional.test_s3:test_post_object_set_invalid_success_code
#           s3tests_boto3.functional.test_s3:test_post_object_set_key_from_filename
#           s3tests_boto3.functional.test_s3:test_post_object_success_redirect_action
#           s3tests_boto3.functional.test_s3:test_post_object_tags_anonymous_request
#           s3tests_boto3.functional.test_s3:test_post_object_tags_authenticated_request
#           s3tests_boto3.functional.test_s3:test_post_object_upload_larger_than_chunk
#           s3tests_boto3.functional.test_s3:test_post_object_upload_size_below_minimum
#           s3tests_boto3.functional.test_s3:test_post_object_upload_size_limit_exceeded
#           s3tests_boto3.functional.test_s3:test_post_object_user_specified_header
#           s3tests_boto3.functional.test_s3:test_put_bucket_encryption_kms
#           s3tests_boto3.functional.test_s3:test_put_bucket_encryption_s3
#           s3tests_boto3.functional.test_s3:test_put_delete_tags
#           s3tests_boto3.functional.test_s3:test_put_excess_key_tags
#           s3tests_boto3.functional.test_s3:test_put_excess_tags
#           s3tests_boto3.functional.test_s3:test_put_excess_val_tags
#           s3tests_boto3.functional.test_s3:test_put_max_kvsize_tags
#           s3tests_boto3.functional.test_s3:test_put_max_tags
#           s3tests_boto3.functional.test_s3:test_put_modify_tags
#           s3tests_boto3.functional.test_s3:test_put_obj_enc_conflict_bad_enc_kms
#           s3tests_boto3.functional.test_s3:test_put_obj_enc_conflict_c_kms
#           s3tests_boto3.functional.test_s3:test_put_obj_enc_conflict_c_s3
#           s3tests_boto3.functional.test_s3:test_put_obj_enc_conflict_s3_kms
#           s3tests_boto3.functional.test_s3:test_put_obj_with_tags
#           s3tests_boto3.functional.test_s3:test_put_object_ifmatch_failed
#           s3tests_boto3.functional.test_s3:test_put_object_ifmatch_good
#           s3tests_boto3.functional.test_s3:test_put_object_ifmatch_nonexisted_failed
#           s3tests_boto3.functional.test_s3:test_put_object_ifmatch_overwrite_existed_good
#           s3tests_boto3.functional.test_s3:test_put_object_ifnonmatch_failed
#           s3tests_boto3.functional.test_s3:test_put_object_ifnonmatch_good
#           s3tests_boto3.functional.test_s3:test_put_object_ifnonmatch_nonexisted_good
#           s3tests_boto3.functional.test_s3:test_put_object_ifnonmatch_overwrite_existed_failed
#           s3tests_boto3.functional.test_s3:test_put_public_block
#           s3tests_boto3.functional.test_s3:test_put_tags_acl_public
#           s3tests_boto3.functional.test_s3:test_ranged_big_request_response_code
#           s3tests_boto3.functional.test_s3:test_ranged_request_empty_object
#           s3tests_boto3.functional.test_s3:test_ranged_request_invalid_range
#           s3tests_boto3.functional.test_s3:test_ranged_request_response_code
#           s3tests_boto3.functional.test_s3:test_ranged_request_return_trailing_bytes_response_code
#           s3tests_boto3.functional.test_s3:test_ranged_request_skip_leading_bytes_response_code
#           s3tests_boto3.functional.test_s3:test_set_bucket_tagging
#           s3tests_boto3.functional.test_s3:test_set_cors
#           s3tests_boto3.functional.test_s3:test_sse_kms_default_post_object_authenticated_request
#           s3tests_boto3.functional.test_s3:test_sse_kms_default_upload_1b
#           s3tests_boto3.functional.test_s3:test_sse_kms_default_upload_1kb
#           s3tests_boto3.functional.test_s3:test_sse_kms_default_upload_1mb
#           s3tests_boto3.functional.test_s3:test_sse_kms_default_upload_8mb
#           s3tests_boto3.functional.test_s3:test_sse_kms_method_head
#           s3tests_boto3.functional.test_s3:test_sse_kms_multipart_invalid_chunks_1
#           s3tests_boto3.functional.test_s3:test_sse_kms_multipart_invalid_chunks_2
#           s3tests_boto3.functional.test_s3:test_sse_kms_multipart_upload
#           s3tests_boto3.functional.test_s3:test_sse_kms_no_key
#           s3tests_boto3.functional.test_s3:test_sse_kms_not_declared
#           s3tests_boto3.functional.test_s3:test_sse_kms_post_object_authenticated_request
#           s3tests_boto3.functional.test_s3:test_sse_kms_present
#           s3tests_boto3.functional.test_s3:test_sse_kms_read_declare
#           s3tests_boto3.functional.test_s3:test_sse_kms_transfer_13b
#           s3tests_boto3.functional.test_s3:test_sse_kms_transfer_1MB
#           s3tests_boto3.functional.test_s3:test_sse_kms_transfer_1b
#           s3tests_boto3.functional.test_s3:test_sse_kms_transfer_1kb
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_method_head
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_multipart_upload
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_post_object_authenticated_request
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_upload_1b
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_upload_1kb
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_upload_1mb
#           s3tests_boto3.functional.test_s3:test_sse_s3_default_upload_8mb
#           s3tests_boto3.functional.test_s3:test_sse_s3_encrypted_upload_1b
#           s3tests_boto3.functional.test_s3:test_sse_s3_encrypted_upload_1kb
#           s3tests_boto3.functional.test_s3:test_sse_s3_encrypted_upload_1mb
#           s3tests_boto3.functional.test_s3:test_sse_s3_encrypted_upload_8mb
#           s3tests_boto3.functional.test_s3:test_user_policy
#           s3tests_boto3.functional.test_s3:test_versioned_concurrent_object_create_and_remove
#           s3tests_boto3.functional.test_s3:test_versioned_concurrent_object_create_concurrent_remove
#           s3tests_boto3.functional.test_s3:test_versioned_object_acl
#           s3tests_boto3.functional.test_s3:test_versioned_object_acl_no_version_specified
#           s3tests_boto3.functional.test_s3:test_versioning_bucket_atomic_upload_return_version_id
#           s3tests_boto3.functional.test_s3:test_versioning_bucket_create_suspend
#           s3tests_boto3.functional.test_s3:test_versioning_bucket_multipart_upload_return_version_id
#           s3tests_boto3.functional.test_s3:test_versioning_copy_obj_version
#           s3tests_boto3.functional.test_s3:test_versioning_multi_object_delete
#           s3tests_boto3.functional.test_s3:test_versioning_multi_object_delete_with_marker
#           s3tests_boto3.functional.test_s3:test_versioning_obj_create_overwrite_multipart
#           s3tests_boto3.functional.test_s3:test_versioning_obj_create_read_remove
#           s3tests_boto3.functional.test_s3:test_versioning_obj_create_read_remove_head
#           s3tests_boto3.functional.test_s3:test_versioning_obj_create_versions_remove_all
#           s3tests_boto3.functional.test_s3:test_versioning_obj_create_versions_remove_special_names
#           s3tests_boto3.functional.test_s3:test_versioning_obj_list_marker
#           s3tests_boto3.functional.test_s3:test_versioning_obj_plain_null_version_overwrite
#           s3tests_boto3.functional.test_s3:test_versioning_obj_plain_null_version_overwrite_suspended
#           s3tests_boto3.functional.test_s3:test_versioning_obj_plain_null_version_removal
#           s3tests_boto3.functional.test_s3:test_versioning_obj_suspend_versions
#           EOF
#
#       - name: Run s3tests
#         run: |
#           mkdir storage
#           docker run -d \
#             -v $GITHUB_WORKSPACE/storage:/data \
#             -p 7480:7480 \
#             s3gw:test-${{ env.GITHUB_REF_NAME }} \
#               --rgw-backend-store sfs \
#               --debug-rgw 1
#
#           sleep 5
#           # ^ This is needed to give the gateway some time to boot up.
#           # It also serves to make sure the gateway takes no more than 5 seconds
#           # to boot up.
#
#           echo "Running S3Tests:\n"
#
#           export S3TEST_CONF=$GITHUB_WORKSPACE/s3gw-tools/tests/regression-tests/s3tests.conf
#           export S3TEST_ATTR='!fails_on_rgw,!lifecycle_expiration,!fails_strict_rfc2616'
#           export S3TEST_CASES=$GITHUB_WORKSPACE/all-s3tests
#
#           cd s3tests
#
#           while read -r test_case ; do
#             nosetests -v -s -a "$S3TEST_ATTR" $test_case
#           done < $S3TEST_CASES

  s3tests-access-bucket:
    runs-on: ubuntu-latest
    needs:
      - build-container

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: /tmp

      - name: Load Image
        run: |
          docker load --input //tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
          docker image ls -a

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Checkout s3tests
        uses: actions/checkout@v3
        with:
          repository: 'ceph/s3-tests'
          ref: 'master'
          path: 's3tests'

      - name: Setup s3tests
        run: |
          pip install -r s3tests/requirements.txt

          cat <<EOF > all-s3tests
          s3tests_boto3.functional.test_s3:test_access_bucket_private_object_private
          s3tests_boto3.functional.test_s3:test_access_bucket_private_object_publicread
          s3tests_boto3.functional.test_s3:test_access_bucket_private_object_publicreadwrite
          s3tests_boto3.functional.test_s3:test_access_bucket_private_objectv2_private
          s3tests_boto3.functional.test_s3:test_access_bucket_private_objectv2_publicread
          s3tests_boto3.functional.test_s3:test_access_bucket_private_objectv2_publicreadwrite
          s3tests_boto3.functional.test_s3:test_access_bucket_publicread_object_private
          s3tests_boto3.functional.test_s3:test_access_bucket_publicread_object_publicread
          s3tests_boto3.functional.test_s3:test_access_bucket_publicread_object_publicreadwrite
          s3tests_boto3.functional.test_s3:test_access_bucket_publicreadwrite_object_private
          s3tests_boto3.functional.test_s3:test_access_bucket_publicreadwrite_object_publicread
          s3tests_boto3.functional.test_s3:test_access_bucket_publicreadwrite_object_publicreadwrite
          EOF

          cat <<EOF > s3tests.conf
          [DEFAULT]
          host = localhost
          port = 7480
          is_secure = False
          ssl_verify = False
          [fixtures]
          bucket prefix = s3gwtest-{random}-
          [s3 main]
          display_name = M. Tester
          user_id = testid
          email = tester@ceph.com
          api_name = default
          access_key = test
          secret_key = test
          [s3 alt]
          display_name = john.doe
          email = john.doe@example.com
          user_id = testid
          access_key = test
          secret_key = test
          [s3 tenant]
          display_name = testx
          user_id = testid
          access_key = test
          secret_key = test
          email = tenanteduser@example.com
          [iam]
          email = s3@example.com
          user_id = testid
          access_key = test
          secret_key = test
          display_name = youruseridhere
          EOF

      - name: Run s3tests
        run: |
          mkdir storage
          docker run -d \
            -v $GITHUB_WORKSPACE/storage:/data \
            -p 7480:7480 \
            s3gw:test-${{ env.GITHUB_REF_NAME }} \
              --rgw-backend-store sfs \
              --debug-rgw 1

          sleep 5
          # ^ This is needed to give the gateway some time to boot up.
          # It also serves to make sure the gateway takes no more than 5 seconds
          # to boot up.

          echo "Running S3Tests:"

          export S3TEST_CONF=$GITHUB_WORKSPACE/s3tests.conf
          export S3TEST_ATTR='!fails_on_rgw,!lifecycle_expiration,!fails_strict_rfc2616'
          export S3TEST_CASES=$GITHUB_WORKSPACE/all-s3tests

          cd s3tests

          while read -r test_case ; do
            nosetests -v -s -a "$S3TEST_ATTR" $test_case
          done < $S3TEST_CASES

  s3tests-bucket-list:
    runs-on: ubuntu-latest
    needs:
      - build-container

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: /tmp

      - name: Load Image
        run: |
          docker load --input //tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
          docker image ls -a

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Checkout s3tests
        uses: actions/checkout@v3
        with:
          repository: 'ceph/s3-tests'
          ref: 'master'
          path: 's3tests'

      - name: Setup s3tests
        run: |
          pip install -r s3tests/requirements.txt

          cat <<EOF > all-s3tests
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_alt
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_basic
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_dot
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_empty
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_none
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_not_skip_special
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_percentage
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix_ends_with_delimiter
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_prefix_underscore
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_list_delimiter_whitespace
          s3tests_boto3.functional.test_s3:test_bucket_list_distinct
          s3tests_boto3.functional.test_s3:test_bucket_list_empty
          s3tests_boto3.functional.test_s3:test_bucket_list_encoding_basic
          s3tests_boto3.functional.test_s3:test_bucket_list_long_name
          s3tests_boto3.functional.test_s3:test_bucket_list_many
          s3tests_boto3.functional.test_s3:test_bucket_list_marker_after_list
          s3tests_boto3.functional.test_s3:test_bucket_list_marker_empty
          s3tests_boto3.functional.test_s3:test_bucket_list_marker_none
          s3tests_boto3.functional.test_s3:test_bucket_list_marker_not_in_list
          s3tests_boto3.functional.test_s3:test_bucket_list_marker_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_invalid
          s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_none
          s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_one
          s3tests_boto3.functional.test_s3:test_bucket_list_maxkeys_zero
          s3tests_boto3.functional.test_s3:test_bucket_list_objects_anonymous
          s3tests_boto3.functional.test_s3:test_bucket_list_objects_anonymous_fail
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_alt
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_basic
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_alt
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_basic
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_prefix_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_delimiter_prefix_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_empty
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_none
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_list_prefix_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_list_return_data
          s3tests_boto3.functional.test_s3:test_bucket_list_return_data_versioning
          s3tests_boto3.functional.test_s3:test_bucket_list_special_prefix
          s3tests_boto3.functional.test_s3:test_bucket_list_unordered
          EOF

          cat <<EOF > s3tests.conf
          [DEFAULT]
          host = localhost
          port = 7480
          is_secure = False
          ssl_verify = False
          [fixtures]
          bucket prefix = s3gwtest-{random}-
          [s3 main]
          display_name = M. Tester
          user_id = testid
          email = tester@ceph.com
          api_name = default
          access_key = test
          secret_key = test
          [s3 alt]
          display_name = john.doe
          email = john.doe@example.com
          user_id = testid
          access_key = test
          secret_key = test
          [s3 tenant]
          display_name = testx
          user_id = testid
          access_key = test
          secret_key = test
          email = tenanteduser@example.com
          [iam]
          email = s3@example.com
          user_id = testid
          access_key = test
          secret_key = test
          display_name = youruseridhere
          EOF

      - name: Run s3tests
        run: |
          mkdir storage
          docker run -d \
            -v $GITHUB_WORKSPACE/storage:/data \
            -p 7480:7480 \
            s3gw:test-${{ env.GITHUB_REF_NAME }} \
              --rgw-backend-store sfs \
              --debug-rgw 1

          sleep 5
          # ^ This is needed to give the gateway some time to boot up.
          # It also serves to make sure the gateway takes no more than 5 seconds
          # to boot up.

          echo "Running S3Tests:"

          export S3TEST_CONF=$GITHUB_WORKSPACE/s3tests.conf
          export S3TEST_ATTR='!fails_on_rgw,!lifecycle_expiration,!fails_strict_rfc2616'
          export S3TEST_CASES=$GITHUB_WORKSPACE/all-s3tests

          cd s3tests

          while read -r test_case ; do
            nosetests -v -s -a "$S3TEST_ATTR" $test_case
          done < $S3TEST_CASES

  s3tests-bucket-listv2:
    runs-on: ubuntu-latest
    needs:
      - build-container

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: s3gw-test-${{ env.GITHUB_REF_NAME }}
          path: /tmp

      - name: Load Image
        run: |
          docker load --input //tmp/s3gw-test-${{ env.GITHUB_REF_NAME }}.tar
          docker image ls -a

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Checkout s3tests
        uses: actions/checkout@v3
        with:
          repository: 'ceph/s3-tests'
          ref: 'master'
          path: 's3tests'

      - name: Setup s3tests
        run: |
          pip install -r s3tests/requirements.txt

          cat <<EOF > all-s3tests
          s3tests_boto3.functional.test_s3:test_bucket_listv2_both_continuationtoken_startafter
          s3tests_boto3.functional.test_s3:test_bucket_listv2_continuationtoken
          s3tests_boto3.functional.test_s3:test_bucket_listv2_continuationtoken_empty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_alt
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_basic
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_dot
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_empty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_none
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_percentage
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix_ends_with_delimiter
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_prefix_underscore
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_listv2_delimiter_whitespace
          s3tests_boto3.functional.test_s3:test_bucket_listv2_encoding_basic
          s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_defaultempty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_empty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_fetchowner_notempty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_many
          s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_none
          s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_one
          s3tests_boto3.functional.test_s3:test_bucket_listv2_maxkeys_zero
          s3tests_boto3.functional.test_s3:test_bucket_listv2_objects_anonymous
          s3tests_boto3.functional.test_s3:test_bucket_listv2_objects_anonymous_fail
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_alt
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_basic
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_alt
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_basic
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_prefix_delimiter_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_delimiter_prefix_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_empty
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_none
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_not_exist
          s3tests_boto3.functional.test_s3:test_bucket_listv2_prefix_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_after_list
          s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_not_in_list
          s3tests_boto3.functional.test_s3:test_bucket_listv2_startafter_unreadable
          s3tests_boto3.functional.test_s3:test_bucket_listv2_unordered
          EOF

          cat <<EOF > s3tests.conf
          [DEFAULT]
          host = localhost
          port = 7480
          is_secure = False
          ssl_verify = False
          [fixtures]
          bucket prefix = s3gwtest-{random}-
          [s3 main]
          display_name = M. Tester
          user_id = testid
          email = tester@ceph.com
          api_name = default
          access_key = test
          secret_key = test
          [s3 alt]
          display_name = john.doe
          email = john.doe@example.com
          user_id = testid
          access_key = test
          secret_key = test
          [s3 tenant]
          display_name = testx
          user_id = testid
          access_key = test
          secret_key = test
          email = tenanteduser@example.com
          [iam]
          email = s3@example.com
          user_id = testid
          access_key = test
          secret_key = test
          display_name = youruseridhere
          EOF

      - name: Run s3tests
        run: |
          mkdir storage
          docker run -d \
            -v $GITHUB_WORKSPACE/storage:/data \
            -p 7480:7480 \
            s3gw:test-${{ env.GITHUB_REF_NAME }} \
              --rgw-backend-store sfs \
              --debug-rgw 1

          sleep 5
          # ^ This is needed to give the gateway some time to boot up.
          # It also serves to make sure the gateway takes no more than 5 seconds
          # to boot up.

          echo "Running S3Tests:"

          export S3TEST_CONF=$GITHUB_WORKSPACE/s3tests.conf
          export S3TEST_ATTR='!fails_on_rgw,!lifecycle_expiration,!fails_strict_rfc2616'
          export S3TEST_CASES=$GITHUB_WORKSPACE/all-s3tests

          cd s3tests

          while read -r test_case ; do
            nosetests -v -s -a "$S3TEST_ATTR" $test_case
          done < $S3TEST_CASES
